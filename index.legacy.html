import React, { useState, useEffect, useMemo } from 'react';
import {
  Box,
  Container,
  Typography,
  Card,
  CardContent,
  Button,
  TextField,
  LinearProgress,
  Chip,
  IconButton,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Grid,
  Paper,
  ThemeProvider,
  createTheme,
  CssBaseline,
  Stack,
  useMediaQuery,
} from '@mui/material';
import {
  VolumeUp,
  Mic,
  CheckCircle,
  Error,
  CameraAlt,
  EmojiEvents,
  History,
  ArrowBack,
  School,
  Star,
} from '@mui/icons-material';
import Confetti from 'react-confetti';

// --- Types ---
type ExerciseType = 'spelling' | 'dictation';

interface SpellingItem {
  id: string;
  phrase: string;
}

interface Exercise {
  id: string;
  title: string;
  date: string;
  spelling: SpellingItem[];
  dictation: string;
}

interface ScoreRecord {
  exerciseId: string;
  score: number;
  total: number;
  date: string;
}

// --- Data Extracted from PDF ---
const EXERCISES: Exercise[] = [
  {
    id: '1.1',
    title: 'P4 Spelling 1.1',
    date: '24 Jan 2026',
    spelling: [
      { id: 's1', phrase: 'peered curiously' },
      { id: 's2', phrase: 'nodded his head' },
      { id: 's3', phrase: 'scooped up' },
      { id: 's4', phrase: 'beamed with pride' },
      { id: 's5', phrase: 'mumbled under his breath' },
    ],
    dictation: `Suddenly, I tripped over a branch. I fell and injured my knee. The dog fell on Tom. Poor Tom had a lot of paw prints on his face. He moaned in pain. I tried to stand up but I could not. Tom gently pushed the dog to the ground and slowly stood up. "How are we going to carry the dog out of the canal?" I asked Tom. Tom stared at me and the dog helplessly.`,
  },
  {
    id: '1.2',
    title: 'P4 Spelling 1.2',
    date: '30 Jan 2026',
    spelling: [
      { id: 's1', phrase: 'elated' },
      { id: 's2', phrase: 'eagerly agreed' },
      { id: 's3', phrase: 'could not contain my excitement' },
      { id: 's4', phrase: 'thanked profusely' },
      { id: 's5', phrase: 'punched the air in delight' },
    ],
    dictation: `Just as we were singing Sally's birthday song, Muffin stood up and circled the cake, sniffing at it without stopping. Before I could say or do anything, Muffin pounced on the cake, squashing it flat. The icing flew everywhere, on the guests' clothes and hair. The singing stopped abruptly. "Muffin! Bad boy! Come here now!" I hollered angrily. I was surprised when my friends said, "Calm down, Alexis. Muffin just thought the cake was a toy. We will find a solution to this."`,
  },
  {
    id: '1.3',
    title: 'P4 Spelling 1.3',
    date: '6 Feb 2026',
    spelling: [
      { id: 's1', phrase: 'face lit up' },
      { id: 's2', phrase: 'a delectable breakfast spread' },
      { id: 's3', phrase: 'no one was in sight' },
      { id: 's4', phrase: 'squealed in delight' },
      { id: 's5', phrase: 'grinning from ear to ear' },
    ],
    dictation: `While Jane was walking to school, she bumped into her friends, Mary, John and Suzy. To her dismay, they seemed to have forgotten that it was her birthday. She tried to drop subtle hints about her birthday, but they just replied that they had plans for the day. "Don't you think you are forgetting something important today?" Jane hinted, trying her best not to show her disappointment.`,
  },
  {
    id: '1.4',
    title: 'P4 Spelling 1.4',
    date: '13 Feb 2026',
    spelling: [
      { id: 's1', phrase: 'froze on the spot' },
      { id: 's2', phrase: 'caught red-handed' },
      { id: 's3', phrase: 'heard a commotion' },
      { id: 's4', phrase: 'snaking queues' },
      { id: 's5', phrase: 'face grimaced in pain' },
    ],
    dictation: `Tom, a friend of Mary, was dashing through the canteen. He was so eager to go to the playground and run in the fields that he did not take notice of his surroundings. Suddenly, just as Mary was turning around with a bowl of steaming noodle soup in her hands to find a seat, Tom collided with her. There was a loud crash followed by an ear-piercing shriek. Mary's steaming soup had scalded her. Unable to take the unbearable pain, she started bawling her eyes out.`,
  },
];

// --- Theme (M3 Expressive) ---
const theme = createTheme({
  palette: {
    mode: 'light',
    primary: { main: '#6750A4', light: '#EADDFF', dark: '#21005D' },
    secondary: { main: '#625B71', light: '#E8DEF8' },
    background: { default: '#FFFBFE', paper: '#F3EDF7' },
    error: { main: '#B3261E' },
    success: { main: '#2e7d32' },
  },
  shape: { borderRadius: 24 },
  typography: {
    fontFamily: '"Roboto Flex", "Roboto", "Helvetica", "Arial", sans-serif',
    h4: { fontWeight: 700 },
    h6: { fontWeight: 600 },
    button: { textTransform: 'none', fontWeight: 600, borderRadius: 20 },
  },
  components: {
    MuiCard: { styleOverrides: { root: { boxShadow: '0px 4px 8px 3px rgba(0,0,0,0.05)' } } },
    MuiButton: { styleOverrides: { root: { borderRadius: 100 } } },
  },
});

// --- Utilities ---
const speak = (text: string) => {
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'en-GB'; // British English preferred for SG context
  utterance.rate = 0.9;
  window.speechSynthesis.speak(utterance);
};

// Chunk dictation by max 5 words or punctuation
const chunkText = (text: string): string[] => {
  const regex = /([^.!?]+[.!?]+)|([^.!?]+$)/g;
  const sentences = text.match(regex) || [];
  const chunks: string[] = [];

  sentences.forEach((sentence) => {
    const words = sentence.trim().split(' ');
    let currentChunk: string[] = [];
    
    words.forEach((word) => {
      currentChunk.push(word);
      if (currentChunk.length >= 5 || word.match(/[.!?]$/)) {
        chunks.push(currentChunk.join(' '));
        currentChunk = [];
      }
    });
    if (currentChunk.length > 0) chunks.push(currentChunk.join(' '));
  });
  return chunks;
};

// --- Components ---

const Dashboard: React.FC<{ 
  onSelect: (ex: Exercise, type: ExerciseType) => void;
  history: ScoreRecord[] 
}> = ({ onSelect, history }) => {
  const getTotalXP = () => history.reduce((acc, curr) => acc + (curr.score * 10), 0);

  return (
    <Container maxWidth="sm" sx={{ py: 4 }}>
      <Stack direction="row" justifyContent="space-between" alignItems="center" mb={4}>
        <Box>
          <Typography variant="h4" color="primary">Hi, Samuel!</Typography>
          <Typography variant="body1" color="text.secondary">Ready to ace Spelling?</Typography>
        </Box>
        <Chip 
          icon={<Star sx={{ color: '#FFD700 !important' }} />} 
          label={`${getTotalXP()} XP`} 
          sx={{ bgcolor: 'primary.main', color: 'white', fontWeight: 'bold', px: 1 }} 
        />
      </Stack>

      <Typography variant="h6" gutterBottom>Upcoming Tests</Typography>
      <Stack spacing={2}>
        {EXERCISES.map((ex) => (
          <Card key={ex.id} sx={{ bgcolor: 'background.paper' }}>
            <CardContent>
              <Stack direction="row" justifyContent="space-between">
                <Typography variant="h6">{ex.title}</Typography>
                <Chip label={ex.date} size="small" variant="outlined" />
              </Stack>
              <Stack direction="row" spacing={1} mt={2}>
                <Button 
                  variant="contained" 
                  onClick={() => onSelect(ex, 'spelling')}
                  startIcon={<School />}
                  fullWidth
                >
                  Spelling
                </Button>
                <Button 
                  variant="outlined" 
                  onClick={() => onSelect(ex, 'dictation')}
                  startIcon={<Mic />}
                  fullWidth
                >
                  Dictation
                </Button>
              </Stack>
            </CardContent>
          </Card>
        ))}
      </Stack>
    </Container>
  );
};

const SpellingMode: React.FC<{ 
  exercise: Exercise; 
  onComplete: (score: number, total: number) => void; 
  onBack: () => void 
}> = ({ exercise, onComplete, onBack }) => {
  const [index, setIndex] = useState(0);
  const [input, setInput] = useState('');
  const [feedback, setFeedback] = useState<'neutral' | 'correct' | 'wrong'>('neutral');
  const [score, setScore] = useState(0);

  const currentWord = exercise.spelling[index];
  const progress = ((index) / exercise.spelling.length) * 100;

  useEffect(() => {
    // Auto-speak on load
    if (feedback === 'neutral') speak(currentWord.phrase);
  }, [index, currentWord, feedback]);

  const handleSubmit = () => {
    const isCorrect = input.toLowerCase().trim() === currentWord.phrase.toLowerCase().trim();
    setFeedback(isCorrect ? 'correct' : 'wrong');
    if (isCorrect) {
      setScore(s => s + 1);
      speak("Correct!");
    } else {
      speak(`Incorrect. The correct spelling is ${currentWord.phrase}`);
    }
  };

  const handleNext = () => {
    if (index < exercise.spelling.length - 1) {
      setIndex(i => i + 1);
      setInput('');
      setFeedback('neutral');
    } else {
      onComplete(score + (feedback === 'correct' ? 1 : 0), exercise.spelling.length);
    }
  };

  return (
    <Container maxWidth="sm" sx={{ height: '100vh', display: 'flex', flexDirection: 'column', pt: 4 }}>
      <IconButton onClick={onBack} sx={{ alignSelf: 'flex-start', mb: 2 }}><ArrowBack /></IconButton>
      <LinearProgress variant="determinate" value={progress} sx={{ borderRadius: 5, height: 10, mb: 4 }} />
      
      <Card sx={{ flexGrow: 1, display: 'flex', flexDirection: 'column', justifyContent: 'center', p: 2 }}>
        <Box sx={{ textAlign: 'center', mb: 4 }}>
          <Fab color="primary" onClick={() => speak(currentWord.phrase)} size="large">
            <VolumeUp fontSize="large" />
          </Fab>
          <Typography variant="caption" display="block" sx={{ mt: 1 }}>Tap to listen</Typography>
        </Box>

        <TextField
          fullWidth
          variant="outlined"
          label="Type the phrase"
          value={input}
          onChange={(e) => setInput(e.target.value)}
          disabled={feedback !== 'neutral'}
          error={feedback === 'wrong'}
          focused
          sx={{ mb: 2 }}
        />

        {feedback === 'wrong' && (
          <Box sx={{ bgcolor: '#ffebee', p: 2, borderRadius: 2, mb: 2, textAlign: 'center' }}>
            <Typography color="error" fontWeight="bold">Correct answer:</Typography>
            <Typography variant="h6">{currentWord.phrase}</Typography>
          </Box>
        )}

        {feedback === 'neutral' ? (
          <Button variant="contained" size="large" onClick={handleSubmit} disabled={!input}>Check</Button>
        ) : (
          <Button variant="contained" size="large" onClick={handleNext} color={feedback === 'correct' ? 'success' : 'primary'}>
            {index === exercise.spelling.length - 1 ? 'Finish' : 'Next Word'}
          </Button>
        )}
      </Card>
    </Container>
  );
};

const DictationMode: React.FC<{ 
  exercise: Exercise; 
  onComplete: (score: number, total: number) => void; 
  onBack: () => void 
}> = ({ exercise, onComplete, onBack }) => {
  const [mode, setMode] = useState<'type' | 'write'>('type');
  const [index, setIndex] = useState(0);
  const [input, setInput] = useState('');
  const [showAnswer, setShowAnswer] = useState(false);
  
  const chunks = useMemo(() => chunkText(exercise.dictation), [exercise.dictation]);
  const currentChunk = chunks[index];

  const handleNext = () => {
    if (index < chunks.length - 1) {
      setIndex(i => i + 1);
      setInput('');
      setShowAnswer(false);
    } else {
      onComplete(100, 100); // Simple completion for dictation
    }
  };

  if (mode === 'write' && showAnswer) {
    return (
      <Container maxWidth="sm" sx={{ py: 4 }}>
        <Typography variant="h5" gutterBottom>Self Check</Typography>
        <Card sx={{ mb: 3, p: 2, bgcolor: '#e8f5e9' }}>
          <Typography variant="caption" color="text.secondary">Correct Text:</Typography>
          <Typography variant="h6">{currentChunk}</Typography>
        </Card>
        <Typography paragraph>Compare this with what you wrote in your notebook.</Typography>
        <Button variant="contained" fullWidth onClick={handleNext}>
          I Checked It (Next Part)
        </Button>
      </Container>
    );
  }

  return (
    <Container maxWidth="sm" sx={{ height: '100vh', pt: 4 }}>
      <Stack direction="row" alignItems="center" mb={2}>
        <IconButton onClick={onBack}><ArrowBack /></IconButton>
        <Typography variant="h6" sx={{ ml: 1 }}>Dictation (Part {index + 1}/{chunks.length})</Typography>
      </Stack>

      <Card sx={{ p: 3, mb: 3, textAlign: 'center' }}>
        <Typography variant="body2" color="text.secondary" gutterBottom>Listen and write</Typography>
        <Fab color="secondary" onClick={() => speak(currentChunk)} sx={{ mb: 2 }}>
          <VolumeUp />
        </Fab>
      </Card>

      {mode === 'type' ? (
        <>
          <TextField
            fullWidth
            multiline
            rows={3}
            label="Type here..."
            value={input}
            onChange={(e) => setInput(e.target.value)}
            sx={{ mb: 3 }}
          />
          <Button 
            variant="contained" 
            fullWidth 
            onClick={() => setShowAnswer(true)}
            disabled={!input}
          >
            Check Answer
          </Button>
          <Button onClick={() => setMode('write')} sx={{ mt: 2 }} fullWidth>
            Switch to Handwriting Mode
          </Button>
        </>
      ) : (
        <>
          <Box sx={{ border: '2px dashed #ccc', borderRadius: 4, p: 4, textAlign: 'center', mb: 3, cursor: 'pointer' }} onClick={() => setShowAnswer(true)}>
            <CameraAlt fontSize="large" color="action" />
            <Typography>Tap to "Scan" your handwriting</Typography>
            <Typography variant="caption">(Simulates photo upload)</Typography>
          </Box>
          <Button onClick={() => setMode('type')} fullWidth>Switch to Typing Mode</Button>
        </>
      )}

      {showAnswer && mode === 'type' && (
        <Dialog open={true} onClose={() => {}}>
          <DialogTitle>Check your work</DialogTitle>
          <DialogContent>
            <Typography color="success.main" fontWeight="bold">Correct:</Typography>
            <Typography paragraph>{currentChunk}</Typography>
            <Typography color="error" fontWeight="bold">You typed:</Typography>
            <Typography>{input}</Typography>
          </DialogContent>
          <DialogActions>
            <Button onClick={handleNext} variant="contained">Next Chunk</Button>
          </DialogActions>
        </Dialog>
      )}
    </Container>
  );
};

// --- Main App Component ---

export default function App() {
  const [view, setView] = useState<'dashboard' | 'exercise'>('dashboard');
  const [activeExercise, setActiveExercise] = useState<Exercise | null>(null);
  const [activeType, setActiveType] = useState<ExerciseType>('spelling');
  const [history, setHistory] = useState<ScoreRecord[]>([]);
  const [showConfetti, setShowConfetti] = useState(false);

  const handleSelect = (ex: Exercise, type: ExerciseType) => {
    setActiveExercise(ex);
    setActiveType(type);
    setView('exercise');
  };

  const handleComplete = (score: number, total: number) => {
    if (activeExercise) {
      setHistory([...history, {
        exerciseId: activeExercise.id,
        score,
        total,
        date: new Date().toLocaleDateString()
      }]);
      setShowConfetti(true);
      setTimeout(() => setShowConfetti(false), 5000);
      setView('dashboard');
    }
  };

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      {showConfetti && <Confetti recycle={false} numberOfPieces={500} />}
      
      {view === 'dashboard' ? (
        <Dashboard onSelect={handleSelect} history={history} />
      ) : activeExercise ? (
        activeType === 'spelling' ? (
          <SpellingMode 
            exercise={activeExercise} 
            onComplete={handleComplete} 
            onBack={() => setView('dashboard')} 
          />
        ) : (
          <DictationMode 
            exercise={activeExercise} 
            onComplete={handleComplete} 
            onBack={() => setView('dashboard')} 
          />
        )
      ) : null}
    </ThemeProvider>
  );
}